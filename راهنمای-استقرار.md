# راهنمای استقرار حساب‌پاک روی هاست پایتون

این راهنما مراحل راه‌اندازی برنامه‌ی Flask «حساب‌پاک» روی هاست پایتون (Passenger) را به زبان ساده توضیح می‌دهد. فرض شده از طریق SSH به سرور متصل شده‌اید و سورس برنامه داخل یک مخزن گیت قرار دارد.

## ۱. آماده‌سازی اولیه
1. سورس پروژه را (به صورت zip یا git) روی سرور قرار دهید و داخل پوشه‌ی آن شوید تا به اسکریپت‌های استقرار دسترسی داشته باشید.
2. فایل تنظیمات محیطی را بسازید (در کنار `app.py`):
   ```bash
   cp .env.sample .env  # در صورت وجود
   nano .env            # مقداردهی متغیرهای موردنیاز مثل SECRET_KEY
   ```
   مقادیر مهم قابل استفاده:
   - `SECRET_KEY` برای نشست‌ها
   - `ADMIN_USERNAME` و `ADMIN_PASSWORD` جهت مدیر پیش‌فرض
   - `DATA_DIR` برای تعیین محل ذخیره دیتابیس و لاگ‌ها

## ۲. اسکریپت‌های استقرار خودکار
در ریشه مخزن دو اسکریپت مکمل وجود دارد:

- `host_setup.sh`
  - دستور `install` را برای اولین راه‌اندازی اجرا کنید؛ مخزن GitHub را (در مسیر پیش‌فرض `~/repositories/hesabpak`) کلون می‌کند یا در صورت وجود، آن را به‌روزرسانی می‌کند و سپس `deploy_host.sh bootstrap` را صدا می‌زند.
  - دستور `update` وضعیت شاخه انتخاب‌شده را با ریموت مقایسه می‌کند، لیست تغییرات را نشان می‌دهد و فقط در صورت تایید شما `git pull` و استقرار را انجام می‌دهد.
  - دستور `status` خلاصه‌ای از وضعیت شاخه محلی نسبت به ریموت ارائه می‌کند.

- `deploy_host.sh`
  - `bootstrap` وِن‌و می‌سازد، وابستگی‌ها را نصب می‌کند و `passenger_wsgi.py` را در `public_html` می‌نویسد.
  - `update` پس از دریافت آخرین تغییرات، وابستگی‌ها را نصب و Passenger را ریستارت می‌کند.
  - `restart` فقط Passenger را ریستارت می‌کند.

> نکته: در صورت متفاوت بودن مسیرها می‌توانید متغیرهایی مثل `REPO_DIR`، `PUBLIC_HTML` یا `VENV_DIR` را قبل از اجرای اسکریپت‌ها ست کنید:
> ```bash
> PUBLIC_HTML=$HOME/www ./deploy_host.sh bootstrap
> ```

## ۳. راه‌اندازی اولیه (نمونه اجرای اسکریپت)
```bash
# داخل پوشه‌ای که اسکریپت‌ها وجود دارند:
chmod +x host_setup.sh deploy_host.sh
./host_setup.sh install --repo-url https://github.com/<user>/hesabpak.git --branch main
```
پس از پایان این مرحله دامنه‌ی متصل به `public_html` به‌صورت خودکار برنامه را نمایش می‌دهد.

## ۴. اتصال دامنه به برنامه
1. بعد از اجرای `install` یا `bootstrap` فایل `passenger_wsgi.py` در `public_html` ساخته می‌شود و مسیر پروژه به صورت خودکار در آن ثبت شده است.
2. اگر از cPanel استفاده می‌کنید کافی است دامنه (مثلاً `hesabpak.com`) به فولدر `public_html` اشاره کند.
3. برای ریستارت سرویس هر زمان کافی است:
   ```bash
   ./deploy_host.sh restart
   ```

## ۵. به‌روزرسانی از گیت
هر زمان تغییری در GitHub انجام شد کافی است داخل سرور اجرا کنید:
```bash
./host_setup.sh update --repo-url https://github.com/<user>/hesabpak.git --branch main
```
پیش از اعمال به‌روزرسانی، لیست کامیت‌های جدید نمایش داده می‌شود و تنها با تایید شما سایت به نسخه‌ی جدید ارتقا می‌یابد.

## ۶. پشتیبان‌گیری و داده‌ها
- دیتابیس SQLite و فایل‌های لاگ داخل پوشه‌ی `data/` در کنار پروژه ذخیره می‌شوند. می‌توانید با تغییر `DATA_DIR` در `.env` مسیر دلخواهی تعیین کنید.
- برای اطمینان از جلوگیری از دسترسی عمومی، این پوشه نباید در `public_html` قرار بگیرد.

## ۷. نکات تکمیلی
- برای ورود به پنل مدیریت از کاربری که در `.env` تعریف کرده‌اید استفاده کنید.
- پس از اولین اجرای برنامه، از طریق منوی «مدیریت → کاربران» قادر به ساخت کاربرهای جدید و تعیین سطح دسترسی آن‌ها هستید.
- هر تغییری در فایل‌های استاتیک یا قالب‌ها نیز پس از اجرای `update` به‌صورت خودکار فعال می‌شود.

با اجرای مراحل بالا، پس از بازکردن دامنه‌ی `https://hesabpak.com` صفحه‌ی ورود برنامه در دسترس خواهد بود و از این پس با اجرای `./host_setup.sh update` می‌توانید پروژه را با نسخه‌ی جدید مخزن همگام نگه دارید.
