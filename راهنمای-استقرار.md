# راهنمای استقرار حساب‌پاک روی هاست پایتون

این راهنما مراحل راه‌اندازی برنامه‌ی Flask «حساب‌پاک» روی هاست پایتون (Passenger) را به زبان ساده توضیح می‌دهد. فرض شده از طریق SSH به سرور متصل شده‌اید و سورس برنامه داخل یک مخزن گیت قرار دارد.

## ۱. آماده‌سازی اولیه
1. وارد سرور شوید و در صورت نیاز یک پوشه برای مخزن بسازید:
   ```bash
   mkdir -p ~/repo && cd ~/repo
   git clone <آدرس-git> hesabpak
   cd hesabpak
   ```
2. فایل تنظیمات محیطی را بسازید (در کنار `app.py`):
   ```bash
   cp .env.sample .env  # در صورت وجود
   nano .env            # مقداردهی متغیرهای موردنیاز مثل SECRET_KEY
   ```
   مقادیر مهم قابل استفاده:
   - `SECRET_KEY` برای نشست‌ها
   - `ADMIN_USERNAME` و `ADMIN_PASSWORD` جهت مدیر پیش‌فرض
   - `DATA_DIR` برای تعیین محل ذخیره دیتابیس و لاگ‌ها

## ۲. اسکریپت استقرار خودکار
در ریشه مخزن فایل `deploy_host.sh` قرار دارد. این اسکریپت سه دستور اصلی دارد:

- `./deploy_host.sh bootstrap`
  - ساخت یا به‌روزرسانی virtualenv در `~/virtualenv/hesabpak`
  - نصب وابستگی‌های Python از `requirements.txt`
  - ایجاد/به‌روزرسانی `~/public_html/passenger_wsgi.py`
  - ریستارت کردن Passenger با `tmp/restart.txt`
- `./deploy_host.sh update`
  - اجرای `git pull` از ریموت (`origin/main` به صورت پیش‌فرض)
  - نصب مجدد وابستگی‌ها
  - ریستارت اپلیکیشن
- `./deploy_host.sh restart`
  - فقط ریستارت Passenger

> نکته: در صورت متفاوت بودن مسیرها می‌توانید متغیرهایی مثل `REPO_DIR`، `PUBLIC_HTML` یا `VENV_DIR` را قبل از اجرای اسکریپت ست کنید:
> ```bash
> PUBLIC_HTML=$HOME/www ./deploy_host.sh bootstrap
> ```

## ۳. اتصال دامنه به برنامه
1. بعد از اجرای `bootstrap` فایل `passenger_wsgi.py` در `public_html` ساخته می‌شود و مسیر پروژه به صورت خودکار در آن ثبت شده است.
2. اگر از cPanel استفاده می‌کنید کافی است دامنه (مثلاً `hesabpak.com`) به فولدر `public_html` اشاره کند.
3. برای ریستارت سرویس هر زمان کافی است:
   ```bash
   ./deploy_host.sh restart
   ```

## ۴. به‌روزرسانی از گیت
هر زمان تغییری در GitHub انجام شد:
```bash
cd ~/repo/hesabpak
./deploy_host.sh update
```
اسکریپت تغییرات را می‌کشد، کتابخانه‌ها را به‌روز می‌کند و سرویس را ریستارت می‌کند.

## ۵. پشتیبان‌گیری و داده‌ها
- دیتابیس SQLite و فایل‌های لاگ داخل پوشه‌ی `data/` در کنار پروژه ذخیره می‌شوند. می‌توانید با تغییر `DATA_DIR` در `.env` مسیر دلخواهی تعیین کنید.
- برای اطمینان از جلوگیری از دسترسی عمومی، این پوشه نباید در `public_html` قرار بگیرد.

## ۶. نکات تکمیلی
- برای ورود به پنل مدیریت از کاربری که در `.env` تعریف کرده‌اید استفاده کنید.
- پس از اولین اجرای برنامه، از طریق منوی «مدیریت → کاربران» قادر به ساخت کاربرهای جدید و تعیین سطح دسترسی آن‌ها هستید.
- هر تغییری در فایل‌های استاتیک یا قالب‌ها نیز پس از اجرای `update` به‌صورت خودکار فعال می‌شود.

با اجرای مراحل بالا، پس از بازکردن دامنه‌ی `https://hesabpak.com` صفحه‌ی ورود برنامه در دسترس خواهد بود و از این پس با اجرای `./deploy_host.sh update` می‌توانید پروژه را با نسخه‌ی جدید مخزن همگام نگه دارید.
