{% extends 'base.html' %}
{% block content %}
<div class="dashboard">
  {% if 'hero' in dashboard_widgets %}
  <div class="dashboard-hero">
    <div class="hero-info">
      <h1>Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ù…Ø¯ÛŒØ±ÛŒØªÛŒ</h1>
      <p>Ù†Ù…Ø§ÛŒ Ú©Ù„ÛŒ Ø¹Ù…Ù„Ú©Ø±Ø¯ Ø§Ù…Ø±ÙˆØ² ÙØ±ÙˆØ´Ú¯Ø§Ù‡.</p>
      <div class="hero-clock" data-live-clock data-jalali="{{ now_info['jalali_date']|fa_digits }}">
        <span class="hero-date" data-role="date">{{ now_info['jalali_date']|fa_digits }}</span>
        <span class="hero-time" data-role="time">--:--:--</span>
      </div>
    </div>
    <div class="hero-stat">
      <div class="hero-value">{{ today_stats.invoice_count|int }}</div>
      <div class="hero-label">ØªØ¹Ø¯Ø§Ø¯ ÙØ§Ú©ØªÙˆØ± ÙØ±ÙˆØ´ Ø§Ù…Ø±ÙˆØ²</div>
    </div>
  </div>
  {% endif %}

  {% if 'stats' in dashboard_widgets %}
  <div class="stats-grid">
    <div class="stat-card">
      <span class="stat-title">Ù…Ø¨Ù„Øº ÙØ±ÙˆØ´ Ø§Ù…Ø±ÙˆØ²</span>
      <span class="stat-value">{{ today_stats.invoice_total|sep }} <span class="unit">ØªÙˆÙ…Ø§Ù†</span></span>
    </div>
    <div class="stat-card">
      <span class="stat-title">Ø¬Ù…Ø¹ Ø¯Ø±ÛŒØ§ÙØªÛŒ Ø§Ù…Ø±ÙˆØ²</span>
      <span class="stat-value">{{ today_stats.receives_total|sep }} <span class="unit">ØªÙˆÙ…Ø§Ù†</span></span>
    </div>
    <div class="stat-card">
      <span class="stat-title">Ø¬Ù…Ø¹ Ù¾Ø±Ø¯Ø§Ø®ØªÛŒ Ø§Ù…Ø±ÙˆØ²</span>
      <span class="stat-value">{{ today_stats.payments_total|sep }} <span class="unit">ØªÙˆÙ…Ø§Ù†</span></span>
    </div>
    <div class="stat-card">
      <span class="stat-title">Ø®Ø§Ù„Øµ ÙˆØ±ÙˆØ¯ ÙˆØ¬Ù‡ Ø§Ù…Ø±ÙˆØ²</span>
      <span class="stat-value">{{ today_stats.net_cash|sep }} <span class="unit">ØªÙˆÙ…Ø§Ù†</span></span>
    </div>
  </div>
  {% endif %}

  {% if 'assistant' in user_permissions %}
  <div class="card assistant-callout">
    <div class="assistant-icon">ğŸ¤–</div>
    <div class="assistant-body">
      <h3>Ø¯Ø³ØªÛŒØ§Ø± Ù‡ÙˆØ´Ù…Ù†Ø¯ Ø­Ø³Ø§Ø¨â€ŒÙ¾Ø§Ú©</h3>
      <p>Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ ØªØµÙˆÛŒØ± ÛŒØ§ Ù…ØªÙ† ÙØ§Ú©ØªÙˆØ± Ùˆ Ø«Ø¨Øª Ø®ÙˆØ¯Ú©Ø§Ø± ÙØ±ÙˆØ´ ÛŒØ§ Ø®Ø±ÛŒØ¯ Ø¨Ø§ Ú©Ù…Ú© Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ.</p>
      <div class="assistant-actions">
        <a class="btn-primary" href="{{ prefix }}/assistant">Ø´Ø±ÙˆØ¹ Ú¯ÙØªâ€ŒÙˆÚ¯Ùˆ</a>
        <span class="assistant-hint">Ù…Ø¯Ù„ ÙØ¹Ø§Ù„: {{ assistant_model_label }}</span>
      </div>
    </div>
  </div>
  {% endif %}

  {% if 'cash' in dashboard_widgets %}
  <div class="balances-card card">
    <h2>Ù…ÙˆØ¬ÙˆØ¯ÛŒ ØµÙ†Ø¯ÙˆÙ‚â€ŒÙ‡Ø§</h2>
    <div class="table-wrapper">
      <table>
        <thead>
          <tr>
            <th>ØµÙ†Ø¯ÙˆÙ‚</th>
            <th>Ø¯Ø±ÛŒØ§ÙØªÛŒ</th>
            <th>Ù¾Ø±Ø¯Ø§Ø®ØªÛŒ</th>
            <th>Ø®Ø§Ù„Øµ</th>
          </tr>
        </thead>
        <tbody>
          {% for row in cash_balances %}
          <tr>
            <td>{{ row.label }}</td>
            <td>{{ row.receive|sep }}</td>
            <td>{{ row.payment|sep }}</td>
            <td class="{{ 'pos' if row.balance >= 0 else 'neg' }}">{{ row.balance|sep }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
  {% endif %}

  {% if 'charts' in dashboard_widgets %}
  <div class="charts-grid">
    <div class="card chart-card">
      <div class="chart-header">
        <h3>Ø±ÙˆÙ†Ø¯ ÙØ±ÙˆØ´ Û· Ø±ÙˆØ² Ø§Ø®ÛŒØ±</h3>
        <span class="chart-sub">Ù…Ø¨Ø§Ù„Øº Ø¨Ù‡ ØªÙˆÙ…Ø§Ù† Ùˆ ØªØ¹Ø¯Ø§Ø¯ ÙØ§Ú©ØªÙˆØ±</span>
      </div>
      <canvas id="salesChart" height="220"></canvas>
    </div>
    <div class="card chart-card">
      <div class="chart-header">
        <h3>Ø¯Ø±ÛŒØ§ÙØªÛŒ Ùˆ Ù¾Ø±Ø¯Ø§Ø®ØªÛŒ Û· Ø±ÙˆØ² Ø§Ø®ÛŒØ±</h3>
        <span class="chart-sub">Ù…Ù‚Ø§ÛŒØ³Ù‡ ÙˆØ±ÙˆØ¯ Ùˆ Ø®Ø±ÙˆØ¬ ÙˆØ¬Ù‡</span>
      </div>
      <canvas id="cashChart" height="220"></canvas>
    </div>
  </div>
  {% endif %}

  {% if 'cheques' in dashboard_widgets %}
  <div class="lists-grid">
    <div class="card list-card">
      <h3>Ú†Ú©â€ŒÙ‡Ø§ÛŒ Ø¯Ø±ÛŒØ§ÙØªÛŒ Ø³Ù‡ Ø±ÙˆØ² Ø¢ÛŒÙ†Ø¯Ù‡</h3>
      {% if incoming_cheques %}
      <ul>
        {% for doc in incoming_cheques %}
        <li>
          <div class="row-main">
            <strong>{{ doc.person }}</strong>
            <span class="amount">{{ doc.amount|sep }} ØªÙˆÙ…Ø§Ù†</span>
          </div>
          <div class="row-meta">{{ doc.date|fa_digits }} | Ø´Ù…Ø§Ø±Ù‡ Ø³Ù†Ø¯ {{ doc.number|fa_digits }}{% if doc.cheque_number %} | Ú†Ú© {{ doc.cheque_number|fa_digits }}{% endif %}</div>
        </li>
        {% endfor %}
      </ul>
      {% else %}
      <div class="empty-state">Ú†Ú©ÛŒ Ø¨Ø±Ø§ÛŒ Ø§ÛŒÙ† Ø¨Ø§Ø²Ù‡ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.</div>
      {% endif %}
    </div>
    <div class="card list-card">
      <h3>Ú†Ú©â€ŒÙ‡Ø§ÛŒ Ù¾Ø±Ø¯Ø§Ø®ØªÛŒ Ø³Ù‡ Ø±ÙˆØ² Ø¢ÛŒÙ†Ø¯Ù‡</h3>
      {% if outgoing_cheques %}
      <ul>
        {% for doc in outgoing_cheques %}
        <li>
          <div class="row-main">
            <strong>{{ doc.person }}</strong>
            <span class="amount">{{ doc.amount|sep }} ØªÙˆÙ…Ø§Ù†</span>
          </div>
          <div class="row-meta">{{ doc.date|fa_digits }} | Ø´Ù…Ø§Ø±Ù‡ Ø³Ù†Ø¯ {{ doc.number|fa_digits }}{% if doc.cheque_number %} | Ú†Ú© {{ doc.cheque_number|fa_digits }}{% endif %}</div>
        </li>
        {% endfor %}
      </ul>
      {% else %}
      <div class="empty-state">Ú†Ú©ÛŒ Ø¨Ø±Ø§ÛŒ Ø§ÛŒÙ† Ø¨Ø§Ø²Ù‡ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.</div>
      {% endif %}
    </div>
  </div>
  {% endif %}
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
(function(){
  const chartData = {{ chart_data|tojson }};
  const numberFormatter = new Intl.NumberFormat('fa-IR');

  function setupSalesChart(){
    const ctx = document.getElementById('salesChart');
    if(!ctx || !window.Chart) return;
    new Chart(ctx, {
      type: 'line',
      data: {
        labels: chartData.labels,
        datasets: [
          {
            type: 'line',
            label: 'Ù…Ø¨Ù„Øº ÙØ±ÙˆØ´',
            data: chartData.salesTotals,
            borderColor: '#804A9D',
            backgroundColor: 'rgba(128,74,157,0.12)',
            borderWidth: 3,
            tension: 0.35,
            yAxisID: 'y',
            fill: true,
          },
          {
            type: 'bar',
            label: 'ØªØ¹Ø¯Ø§Ø¯ ÙØ§Ú©ØªÙˆØ±',
            data: chartData.invoiceCounts,
            backgroundColor: 'rgba(0,123,167,0.35)',
            borderRadius: 8,
            yAxisID: 'y1',
          }
        ],
      },
      options: {
        responsive: true,
        interaction: { mode: 'index', intersect: false },
        scales: {
          y: {
            position: 'right',
            ticks: {
              callback: (value) => numberFormatter.format(value)
            },
            grid: { color: 'rgba(0,0,0,0.05)' }
          },
          y1: {
            position: 'left',
            grid: { drawOnChartArea: false },
            ticks: {
              stepSize: 1,
            }
          }
        },
        plugins: {
          legend: {
            labels: { font: { family: 'Yekan', size: 12 } }
          },
          tooltip: {
            callbacks: {
              label: function(ctx){
                const val = ctx.parsed.y;
                const formatted = numberFormatter.format(val);
                return ctx.dataset.label + ': ' + formatted;
              }
            }
          }
        }
      }
    });
  }

  function setupCashChart(){
    const ctx = document.getElementById('cashChart');
    if(!ctx || !window.Chart) return;
    new Chart(ctx, {
      type: 'bar',
      data: {
        labels: chartData.labels,
        datasets: [
          {
            label: 'Ø¯Ø±ÛŒØ§ÙØªÛŒ',
            data: chartData.receivesTotals,
            backgroundColor: 'rgba(6, 150, 85, 0.65)',
            borderRadius: 6,
          },
          {
            label: 'Ù¾Ø±Ø¯Ø§Ø®ØªÛŒ',
            data: chartData.paymentsTotals,
            backgroundColor: 'rgba(227, 105, 19, 0.55)',
            borderRadius: 6,
          }
        ]
      },
      options: {
        responsive: true,
        interaction: { mode: 'index', intersect: false },
        scales: {
          y: {
            beginAtZero: true,
            ticks: {
              callback: (value) => numberFormatter.format(value)
            },
            grid: { color: 'rgba(0,0,0,0.05)' }
          }
        },
        plugins: {
          legend: {
            labels: { font: { family: 'Yekan', size: 12 } }
          },
          tooltip: {
            callbacks: {
              label: function(ctx){
                const val = ctx.parsed.y;
                const formatted = numberFormatter.format(val);
                return ctx.dataset.label + ': ' + formatted + ' ØªÙˆÙ…Ø§Ù†';
              }
            }
          }
        }
      }
    });
  }

  setupSalesChart();
  setupCashChart();
})();
</script>
{% endblock %}
