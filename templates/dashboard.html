{% extends 'base.html' %}
{% block content %}
<div class="dashboard">
  {% if 'hero' in dashboard_widgets %}
  <div class="dashboard-hero">
    <div class="hero-info">
      <h1>ุฏุงุดุจูุฑุฏ ูุฏุฑุช</h1>
      <p>ููุง ฺฉู ุนููฺฉุฑุฏ ุงูุฑูุฒ ูุฑูุดฺฏุงู.</p>
      <div class="hero-clock" data-live-clock data-jalali="{{ now_info['jalali_date']|fa_digits }}">
        <span class="hero-date" data-role="date">{{ now_info['jalali_date']|fa_digits }}</span>
        <span class="hero-time" data-role="time">--:--:--</span>
      </div>
    </div>
    <div class="hero-stat">
      <div class="hero-value">{{ today_stats.invoice_count|int }}</div>
      <div class="hero-label">ุชุนุฏุงุฏ ูุงฺฉุชูุฑ ูุฑูุด ุงูุฑูุฒ</div>
    </div>
  </div>
  {% endif %}

  {% if 'stats' in dashboard_widgets %}
  <div class="stats-grid">
    <div class="stat-card">
      <span class="stat-title">ูุจูุบ ูุฑูุด ุงูุฑูุฒ</span>
      <span class="stat-value">{{ today_stats.sales_total|sep }} <span class="unit">ุชููุงู</span></span>
    </div>
    <div class="stat-card">
      <span class="stat-title">ูุจูุบ ุฎุฑุฏ ุงูุฑูุฒ</span>
      <span class="stat-value">{{ today_stats.purchase_total|sep }} <span class="unit">ุชููุงู</span></span>
    </div>
    <div class="stat-card">
      <span class="stat-title">ุฌูุน ุฏุฑุงูุช ุงูุฑูุฒ</span>
      <span class="stat-value">{{ today_stats.receives_total|sep }} <span class="unit">ุชููุงู</span></span>
    </div>
    <div class="stat-card">
      <span class="stat-title">ุฌูุน ูพุฑุฏุงุฎุช ุงูุฑูุฒ</span>
      <span class="stat-value">{{ today_stats.payments_total|sep }} <span class="unit">ุชููุงู</span></span>
    </div>
    <div class="stat-card">
      <span class="stat-title">ุฎุงูุต ูุฑูุฏ ูุฌู ุงูุฑูุฒ</span>
      <span class="stat-value">{{ today_stats.net_cash|sep }} <span class="unit">ุชููุงู</span></span>
    </div>
  </div>
  {% endif %}

  {% if 'assistant' in user_permissions %}
  <!-- Inline assistant widget on dashboard -->
  <div class="module-wrap assistant-module">
    <div class="assistant-header card">
      <div>
        <h2>๐ค ุฏุณุชุงุฑ ููุดููุฏ</h2>
        <p class="muted">ฺฏูุชโูฺฏู ุณุฑุน: ูุชู ุง ุชุตูุฑ ูุงฺฉุชูุฑ ุฑุง ุงูุฌุง ุงุฑุณุงู ฺฉูุฏ ุชุง ูพุดโููุงุด ู ฺฏุฒูู ุซุจุช ุจู ุดูุง ูุดุงู ุฏุงุฏู ุดูุฏ.</p>
      </div>
      <div class="assistant-status {{ 'ready' if api_ready else 'missing' }}">
        {% if api_ready %}
        <span class="dot"></span> ูุนุงู โ ุงุชุตุงู ุจุฑูุฑุงุฑ ุงุณุช
        {% else %}
        <span class="dot"></span> ุบุฑูุนุงู โ ุงุจุชุฏุง ฺฉูุฏ API ุฑุง ุฏุฑ ุชูุธูุงุช ุซุจุช ฺฉูุฏ
        {% endif %}
      </div>
    </div>

    <div class="assistant-layout card">
      <section class="assistant-chat">
        <div id="assistant-messages" class="assistant-messages" data-empty-text="ูพุงู ุฎูุฏ ุฑุง ุจููุณุฏ ุง ุชุตูุฑ ูุงฺฉุชูุฑ ุฑุง ุขูพููุฏ ฺฉูุฏ."></div>
        <form id="assistant-form" class="assistant-form" autocomplete="off">
          <textarea id="assistant-input" class="assistant-input" rows="3" placeholder="ุณูุงู ุง ุชูุถุญ ุฎูุฏ ุฑุง ุจููุณุฏ..." {% if not api_ready %}disabled{% endif %}></textarea>
          <div class="assistant-actions">
            <label class="file-btn">
              ๐ ุขูพููุฏ ูุงฺฉุชูุฑ
              <input type="file" id="assistant-file" accept="image/*" {% if not api_ready %}disabled{% endif %}>
            </label>
            <button type="submit" class="btn-primary" {% if not api_ready %}disabled{% endif %}>ุงุฑุณุงู</button>
          </div>
          <div class="assistant-hints">
            <span>ุฑุงูููุง: ยซุงู ูุงฺฉุชูุฑ ูุฑูุด ุฑุง ุซุจุช ฺฉูยปุ ยซุงุฒ ุนู ุฏุฑุงูุช ฒฐฐฐฐ ุชููุงู ุซุจุช ฺฉูยปุ ุง ยซุงููุงู ุงู ุชุตูุฑ ุฑุง ุงุณุชุฎุฑุงุฌ ฺฉูยป.</span>
          </div>
        </form>
      </section>

      <aside class="assistant-sidebar">
        <div id="assistant-preview" class="assistant-preview" hidden>
          <h3>ูพุดโููุงุด</h3>
          <div class="preview-meta">
            <div><span>ููุน:</span> <strong data-field="kind">โ</strong></div>
            <div><span>ูุดุชุฑ/ุชุฃููโฺฉููุฏู:</span> <strong data-field="partner">โ</strong></div>
            <div><span>ุชุงุฑุฎ:</span> <strong data-field="date">โ</strong></div>
            <div><span>ุดูุงุฑู:</span> <strong data-field="number">โ</strong></div>
          </div>
          <div class="preview-items">
            <table>
              <thead>
                <tr>
                  <th>ฺฉุงูุง</th>
                  <th>ุชุนุฏุงุฏ</th>
                  <th>ููุช ูุงุญุฏ</th>
                  <th>ุฌูุน</th>
                  <th>ูุถุนุช</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
          <div class="preview-total">ูุจูุบ ฺฉู: <strong data-field="total">ฐ</strong> ุชููุงู</div>
          <div id="assistant-missing" class="assistant-missing" hidden></div>
          <div id="assistant-error" class="assistant-error" hidden></div>
          <div class="preview-actions">
            <button type="button" id="assistant-confirm" class="btn-primary">ุชุฃุฏ ู ุซุจุช ุฏุฑ ุณุณุชู</button>
            <button type="button" id="assistant-cancel" class="btn-secondary">ุงูุตุฑุงู</button>
          </div>
        </div>

        <div class="assistant-tips">
          <h3>ูฺฉุงุช ุงุณุชูุงุฏู</h3>
          <ul>
            <li>ุชุตุงูุฑ ูุงุถุญ ู ุฎูุงูุง ุจุง ุญุฏุงฺฉุซุฑ ุญุฌู ฒ ูฺฏุงุจุงุช ูุชุฌู ุจูุชุฑ ุฎูุงููุฏ ุฏุงุดุช.</li>
            <li>ุงฺฏุฑ ูุงู ูุดุชุฑ ุง ฺฉุงูุง ุฑุง ููโุดูุงุณูุ ุฏุณุชุงุฑ ุจุฑุง ุงุฌุงุฏ ุฑฺฉูุฑุฏ ุฌุฏุฏ ุงุฒ ุดูุง ุงุฌุงุฒู ูโฺฏุฑุฏ.</li>
            <li>ุชุงุฑุฎโูุง ุดูุณ ุจูโุตูุฑุช ุฎูุฏฺฉุงุฑ ุชุจุฏู ูโุดููุฏ.</li>
          </ul>
        </div>
      </aside>
    </div>
  </div>
  {% endif %}

  {# Cash balances card removed per request #}

  {# Charts removed from dashboard per request #}

  {# Cheque lists removed from dashboard per request #}
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
(function(){
  const chartData = {{ chart_data|tojson }};
  const numberFormatter = new Intl.NumberFormat('fa-IR');

  function setupSalesChart(){
    const ctx = document.getElementById('salesChart');
    if(!ctx || !window.Chart) return;
    new Chart(ctx, {
      type: 'line',
      data: {
        labels: chartData.labels,
        datasets: [
          {
            type: 'line',
            label: 'ูุจูุบ ุฎุฑุฏ',
            data: chartData.purchaseTotals || [],
            borderColor: '#DD6B5A',
            backgroundColor: 'rgba(221,107,90,0.08)',
            borderWidth: 2,
            tension: 0.35,
            yAxisID: 'y',
            fill: true,
          },
          {
            type: 'line',
            label: 'ูุจูุบ ูุฑูุด',
            data: chartData.salesTotals,
            borderColor: '#804A9D',
            backgroundColor: 'rgba(128,74,157,0.12)',
            borderWidth: 3,
            tension: 0.35,
            yAxisID: 'y',
            fill: true,
          },
          {
            type: 'bar',
            label: 'ุชุนุฏุงุฏ ูุงฺฉุชูุฑ',
            data: chartData.invoiceCounts,
            backgroundColor: 'rgba(0,123,167,0.35)',
            borderRadius: 8,
            yAxisID: 'y1',
          }
        ],
      },
      options: {
        responsive: true,
        interaction: { mode: 'index', intersect: false },
        scales: {
          y: {
            position: 'right',
            ticks: {
              callback: (value) => numberFormatter.format(value)
            },
            grid: { color: 'rgba(0,0,0,0.05)' }
          },
          y1: {
            position: 'left',
            grid: { drawOnChartArea: false },
            ticks: {
              stepSize: 1,
            }
          }
        },
        plugins: {
          legend: {
            labels: { font: { family: 'Yekan', size: 12 } }
          },
          tooltip: {
            callbacks: {
              label: function(ctx){
                const val = ctx.parsed.y;
                const formatted = numberFormatter.format(val);
                return ctx.dataset.label + ': ' + formatted;
              }
            }
          }
        }
      }
    });
  }

  function setupCashChart(){
    const ctx = document.getElementById('cashChart');
    if(!ctx || !window.Chart) return;
    new Chart(ctx, {
      type: 'bar',
      data: {
        labels: chartData.labels,
        datasets: [
          {
            label: 'ุฏุฑุงูุช',
            data: chartData.receivesTotals,
            backgroundColor: 'rgba(6, 150, 85, 0.65)',
            borderRadius: 6,
          },
          {
            label: 'ูพุฑุฏุงุฎุช',
            data: chartData.paymentsTotals,
            backgroundColor: 'rgba(227, 105, 19, 0.55)',
            borderRadius: 6,
          }
        ]
      },
      options: {
        responsive: true,
        interaction: { mode: 'index', intersect: false },
        scales: {
          y: {
            beginAtZero: true,
            ticks: {
              callback: (value) => numberFormatter.format(value)
            },
            grid: { color: 'rgba(0,0,0,0.05)' }
          }
        },
        plugins: {
          legend: {
            labels: { font: { family: 'Yekan', size: 12 } }
          },
          tooltip: {
            callbacks: {
              label: function(ctx){
                const val = ctx.parsed.y;
                const formatted = numberFormatter.format(val);
                return ctx.dataset.label + ': ' + formatted + ' ุชููุงู';
              }
            }
          }
        }
      }
    });
  }

  setupSalesChart();
  setupCashChart();
})();
</script>
{% block body_scripts %}
<script src="{{ prefix }}/static/assistant.js"></script>
{% endblock %}
{% endblock %}
