{% extends 'base.html' %}
{% block content %}
<h2>فهرست {{ 'اشخاص' if kind=='person' else 'کالاها' }}</h2>

<form method="get" action="{{ prefix }}/entities" class="filters">
  <input type="hidden" name="kind" value="{{ kind }}">
  <div class="search-wrap" style="display:inline-block;">
    <input name="q" value="{{ q or '' }}" placeholder="جستجو بر اساس نام یا کد" class="search-inp inp" data-kind="{{ kind }}" style="max-width:320px">
    <div class="search-results" hidden></div>
  </div>
  <select class="inp" name="per_page" style="max-width:120px">
    {% set p = per_page|default(50) %}
    <option value="20"    {{ 'selected' if p==20 }}>۲۰</option>
    <option value="50"    {{ 'selected' if p==50 }}>۵۰</option>
    <option value="100"   {{ 'selected' if p==100 }}>۱۰۰</option>
    <option value="200"   {{ 'selected' if p==200 }}>۲۰۰</option>
  </select>
  <button class="btn-primary" style="width:auto; padding:0 16px">جستجو</button>

  <div style="margin-right:auto"></div>

  <a class="card" href="{{ prefix }}/entities?kind=item" style="padding:8px 12px; {{ 'background:var(--c-accent-soft);border-color:rgba(128,74,157,0.35);color:var(--c-accent);' if kind=='item' else '' }}">کالاها</a>
  <a class="card" href="{{ prefix }}/entities?kind=person" style="padding:8px 12px; {{ 'background:var(--c-accent-soft);border-color:rgba(128,74,157,0.35);color:var(--c-accent);' if kind=='person' else '' }}">اشخاص</a>

  <a href="{{ prefix }}/entities/new" class="card" style="padding:8px 12px">+ ثبت جدید</a>
</form>

<div class="table-responsive">
  <table class="table">
    <thead>
      <tr>
        <th>کد</th>
        <th>نام</th>
        {% if kind == 'item' %}
          <th>واحد</th>
          <th>موجودی</th>
          <th>آخرین قیمت خرید</th>
          <th>آخرین قیمت فروش</th>
        {% else %}
          <th>نوع شخص</th>
          <th>مانده</th>
          <th>وضعیت</th>
        {% endif %}
        <th>سطح</th>
        {% if is_admin %}<th class="center">عملیات</th>{% endif %}
      </tr>
    </thead>
    <tbody>
      {% for item in rows %}
        {% set r = item.entity %}
      <tr>
        <td><code>{{ r.code|fa_digits }}</code></td>
        <td>{{ r.name }}</td>
        {% if kind == 'item' %}
          <td>{{ r.unit or '-' }}</td>
          <td>{{ item.stock|sep }}</td>
          <td>{{ item.last_purchase_price|sep if item.last_purchase_price is not none else '—' }}</td>
          <td>{{ item.last_sale_price|sep if item.last_sale_price is not none else '—' }}</td>
        {% else %}
          <td>{{ r.unit or '-' }}</td>
          <td>{{ item.balance|sep }}</td>
          <td>{{ item.status }}</td>
        {% endif %}
        <td>{{ r.level|fa_digits }}</td>
        {% if is_admin %}
        <td class="center">
          <div class="ops">
            <a href="{{ prefix }}/entities/{{ r.id }}/edit">ویرایش</a>
            <form method="post" action="{{ prefix }}/entities/{{ r.id }}/delete" onsubmit="return confirm('حذف شود؟')">
              <button class="link-danger" type="submit">حذف</button>
            </form>
          </div>
        </td>
        {% endif %}
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<div class="pager" style="display:flex;gap:8px;align-items:center;justify-content:center;margin-top:10px;">
  {% if has_prev %}
    <a class="btn" href="?{{ request.query_string.decode('utf-8')|replace('page=' ~ page, 'page=' ~ (page-1)) }}">← قبلی</a>
  {% else %}
    <span class="btn" style="opacity:0.5;pointer-events:none;">← قبلی</span>
  {% endif %}
  <span class="muted">صفحه {{ page|fa_digits }} از {{ ((total + per_page - 1) // per_page)|fa_digits }}</span>
  {% if has_next %}
    <a class="btn" href="?{{ request.query_string.decode('utf-8')|replace('page=' ~ page, 'page=' ~ (page+1)) if 'page=' in request.query_string.decode('utf-8') else (request.query_string.decode('utf-8') ~ ('&' if request.query_string else '') ~ 'page=' ~ (page+1)) }}">بعدی →</a>
  {% else %}
    <span class="btn" style="opacity:0.5;pointer-events:none;">بعدی →</span>
  {% endif %}
</div>
{% endblock %}
