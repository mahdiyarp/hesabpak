{% extends "base.html" %}
{% block content %}
<div class="module-wrap">
  <h2>ğŸ—„ï¸ Ù…Ø§Ú˜ÙˆÙ„ Ø¨Ú©Ø§Ù¾</h2>

  <div class="card">
    {% if last_auto_backup %}
      <strong>â±ï¸ Ø¢Ø®Ø±ÛŒÙ† Ø¨Ú©Ø§Ù¾ Ø®ÙˆØ¯Ú©Ø§Ø±:</strong>
      <span>{{ last_auto_backup }}</span>
    {% else %}
      <strong>â±ï¸ Ø¢Ø®Ø±ÛŒÙ† Ø¨Ú©Ø§Ù¾ Ø®ÙˆØ¯Ú©Ø§Ø±:</strong>
      <span>ØªØ§ Ú©Ù†ÙˆÙ† Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª</span>
    {% endif %}
  </div>

  <div class="card">
    <h3>Ø¨Ú©Ø§Ù¾ Ú©Ø§Ù…Ù„</h3>
    <p class="muted">ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ Ø¯Ø± Ù¾ÙˆØ´Ù‡Ù” {% if current_year_key %}<code>{{ current_year_key }}</code>{% else %}<code>backups</code>{% endif %} Ø°Ø®ÛŒØ±Ù‡ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯.</p>
    <form method="post" action="{{ url_for('backup.create') }}">
      <input type="text" name="reason" placeholder="ØªÙˆØ¶ÛŒØ­ (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)" class="input">
      <button class="btn btn-primary">Ø³Ø§Ø®Øª Ø¨Ú©Ø§Ù¾</button>
    </form>
  </div>

  <div class="card">
    <h3>Ø³Ø§Ù„ Ù…Ø§Ù„ÛŒ</h3>
    <p>Ø³Ø§Ù„ ÙØ¹Ø§Ù„: <b>{{ fiscal_year_start }}</b></p>

    {% if fiscal_years %}
      <form method="post" action="{{ url_for('backup.switch_year') }}" class="stack-form">
        <label for="fiscal-year-select">ØªØºÛŒÛŒØ± Ø³Ø§Ù„ Ù…Ø§Ù„ÛŒ:</label>
        <select id="fiscal-year-select" name="year" class="input">
          {% for year in fiscal_years %}
            <option value="{{ year.start }}" {% if year.start == current_year_value %}selected{% endif %}>{{ year.label }}</option>
          {% endfor %}
        </select>
        <button class="btn">Ø§Ø¹Ù…Ø§Ù„</button>
      </form>
      <details class="case-hints">
        <summary>Ù¾Ø±ÙˆÙ†Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯Ù‡</summary>
        <ul>
          {% for year in fiscal_years %}
            {% set info = case_info.get(year.start) %}
            <li>
              <span>{{ year.label }}</span>
              {% if info and info.snapshot %}
                <span class="tag tag-ok">Ù¾Ø±ÙˆÙ†Ø¯Ù‡ Ø«Ø¨Øª Ø´Ø¯Ù‡</span>
              {% else %}
                <span class="tag tag-warn">ÙØ§Ù‚Ø¯ Ù¾Ø±ÙˆÙ†Ø¯Ù‡</span>
              {% endif %}
              {% if info %}
                <code class="path">{{ info.folder }}</code>
              {% endif %}
            </li>
          {% endfor %}
        </ul>
      </details>
    {% else %}
      <p class="muted">Ù‡Ù†ÙˆØ² Ø³Ø§Ù„ Ù…Ø§Ù„ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.</p>
    {% endif %}

    <hr>

    <form method="post" action="{{ url_for('backup.new_year') }}" class="new-year-form" onsubmit="return confirm('Ø¨Ú©Ø§Ù¾ Ú¯Ø±ÙØªÙ‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯ Ùˆ ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø³Ø§Ù„ Ù…Ø§Ù„ÛŒ Ø¬Ø¯ÛŒØ¯ Ø§Ø¹Ù…Ø§Ù„ Ù…ÛŒâ€ŒÚ¯Ø±Ø¯Ø¯. Ø§Ø¯Ø§Ù…Ù‡ØŸ');">
      <h4>Ø´Ø±ÙˆØ¹ Ø³Ø§Ù„ Ù…Ø§Ù„ÛŒ Ø¬Ø¯ÛŒØ¯</h4>
      <label for="fiscal-year-start-fa">ØªØ§Ø±ÛŒØ® Ø´Ù…Ø³ÛŒ</label>
      <div class="jalali-group">
        <input type="text" id="fiscal-year-start-fa" name="start_date_fa" class="input" data-jalali-input data-jalali-target="fiscal-year-start-greg" placeholder="Û±Û´Û°Û³-Û°Û±-Û°Û±" autocomplete="off">
        <input type="hidden" id="fiscal-year-start-greg" name="start_date">
      </div>

      <fieldset class="mode-options">
        <legend>ÙˆØ¶Ø¹ÛŒØª Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§</legend>
        <label><input type="radio" name="mode" value="reset" checked> Ø´Ø±ÙˆØ¹ Ù¾Ø§Ú© (Ø±ÛŒØ³Øª Ú©Ø§Ù…Ù„)</label>
        <label><input type="radio" name="mode" value="carry"> Ø§Ù†ØªÙ‚Ø§Ù„ Ø§Ø² Ù¾Ø±ÙˆÙ†Ø¯Ù‡Ù” Ù…ÙˆØ¬ÙˆØ¯</label>
      </fieldset>

      <div id="carry-config" class="carry-config" hidden>
        <label for="carry-from">Ø§Ù†ØªØ®Ø§Ø¨ Ø³Ø§Ù„ Ù…Ø±Ø¬Ø¹:</label>
        <select id="carry-from" name="carry_from" class="input">
          <option value="">-- Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯ --</option>
          {% for year in fiscal_years %}
            {% set info = case_info.get(year.start) %}
            {% if info and info.snapshot %}
              <option value="{{ year.start }}">{{ year.label }}</option>
            {% endif %}
          {% endfor %}
        </select>
        <p class="muted">ÙÙ‚Ø· Ù¾Ø±ÙˆÙ†Ø¯Ù‡â€ŒÙ‡Ø§ÛŒÛŒ Ú©Ù‡ Ù‚Ø¨Ù„Ø§Ù‹ Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯Ù‡â€ŒØ§Ù†Ø¯ Ù‚Ø§Ø¨Ù„ Ø§Ù†ØªØ®Ø§Ø¨ Ù‡Ø³ØªÙ†Ø¯.</p>
        <div class="carry-grid">
          <label><input type="checkbox" name="carry_options" value="accounts" checked> Ø³Ø±ÙØµÙ„â€ŒÙ‡Ø§ÛŒ Ø­Ø³Ø§Ø¨</label>
          <label><input type="checkbox" name="carry_options" value="entities" checked> Ø§Ø´Ø®Ø§Øµ Ùˆ Ú©Ø§Ù„Ø§Ù‡Ø§</label>
          <label><input type="checkbox" name="carry_options" value="balances"> Ù…Ø§Ù†Ø¯Ù‡ Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ùˆ Ø¨Ø¯Ù‡ÛŒ</label>
          <label><input type="checkbox" name="carry_options" value="cashboxes" checked> ØµÙ†Ø¯ÙˆÙ‚â€ŒÙ‡Ø§ Ùˆ Ø­Ø³Ø§Ø¨â€ŒÙ‡Ø§ÛŒ Ø¨Ø§Ù†Ú©ÛŒ</label>
          <label><input type="checkbox" name="carry_options" value="prices"> Ø³ÙˆØ§Ø¨Ù‚ Ù‚ÛŒÙ…Øªâ€ŒÚ¯Ø°Ø§Ø±ÛŒ</label>
        </div>
      </div>

      <button class="btn btn-primary">Ø´Ø±ÙˆØ¹ Ø³Ø§Ù„ Ù…Ø§Ù„ÛŒ Ø¬Ø¯ÛŒØ¯</button>
    </form>
  </div>

  <div class="card">
    <h3>ÙÙ‡Ø±Ø³Øª Ø¨Ú©Ø§Ù¾â€ŒÙ‡Ø§</h3>
    <table class="table">
      <thead><tr><th>Ù†Ø§Ù… ÙØ§ÛŒÙ„</th><th>Ø³Ø§Ù„</th><th>Ø­Ø¬Ù…</th><th>ØªØ§Ø±ÛŒØ®</th><th class="center">Ø§Ù‚Ø¯Ø§Ù…Ø§Øª</th></tr></thead>
      <tbody>
        {% for b in backups %}
        <tr>
          <td>{{ b.name }}</td>
          <td>{% if b.year %}{{ b.year }}{% else %}<span class="muted">Ø¹Ù…ÙˆÙ…ÛŒ</span>{% endif %}</td>
          <td>{{ "{:,}".format(b.size) }} bytes</td>
          <td>{{ b.mtime }}</td>
          <td class="center">
            <div class="ops">
              <a class="btn btn-small" href="{{ url_for('backup.download', name=b.name, year=b.year) }}">Ø¯Ø§Ù†Ù„ÙˆØ¯</a>
              <form method="post" action="{{ url_for('backup.restore') }}"
                    onsubmit="return confirm('Ø±ÛŒâ€ŒØ§Ø³ØªÙˆØ± Ø§ÛŒÙ† ÙØ§ÛŒÙ„ Ø§Ù†Ø¬Ø§Ù… Ø´ÙˆØ¯ØŸ (Ù¾Ø³ Ø§Ø² Ø¢Ù† Ø±ÛŒâ€ŒØ§Ø³ØªØ§Ø±Øª Ø³Ø±ÙˆÛŒØ³ Ù„Ø§Ø²Ù… Ø§Ø³Øª)');">
                <input type="hidden" name="name" value="{{ b.name }}">
                <input type="hidden" name="year" value="{{ b.year }}">
                <button class="btn btn-small btn-danger" type="submit">Ø±ÛŒâ€ŒØ§Ø³ØªÙˆØ±</button>
              </form>
            </div>
          </td>
        </tr>
        {% else %}
        <tr><td colspan="5">Ù‡ÛŒÚ† Ø¨Ú©Ø§Ù¾ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<style>
  .case-hints { margin-top: 12px; }
  .case-hints summary { cursor: pointer; }
  .case-hints ul { list-style: none; margin: 8px 0 0; padding: 0; display: flex; flex-direction: column; gap: 6px; }
  .case-hints li { display: flex; flex-direction: column; gap: 4px; padding: 6px 8px; border-radius: 8px; background: var(--c-surface-soft); }
  .case-hints .path { font-size: 11px; direction: ltr; }
  .tag { font-size: 11px; padding: 2px 6px; border-radius: 999px; }
  .tag-ok { background: var(--c-success-soft); color: var(--c-success); }
  .tag-warn { background: var(--c-warn-soft); color: var(--c-warn); }
  .new-year-form { display: flex; flex-direction: column; gap: 12px; }
  .jalali-group { display: flex; gap: 8px; align-items: center; }
  .jalali-group input[type="text"] { flex: 1; }
  .mode-options { display: flex; gap: 16px; align-items: center; flex-wrap: wrap; }
  .mode-options label { display: flex; align-items: center; gap: 6px; }
  .carry-config { border: 1px dashed var(--c-border); padding: 12px; border-radius: 8px; background: var(--c-surface-soft); }
  .carry-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 8px; margin-top: 8px; }
  .stack-form { display: flex; flex-direction: column; gap: 8px; }
</style>
<script>
(function(){
  const radios = document.querySelectorAll('input[name="mode"]');
  const config = document.getElementById('carry-config');
  const toggle = () => {
    const mode = document.querySelector('input[name="mode"]:checked');
    if(mode && mode.value === 'carry'){
      config.hidden = false;
    } else {
      config.hidden = true;
    }
  };
  radios.forEach(r => r.addEventListener('change', toggle));
  toggle();
})();
</script>
{% endblock %}
