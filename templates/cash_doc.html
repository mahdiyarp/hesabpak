{% extends "base.html" %}
{% block content %}
<div class="module-wrap cash-module">
  <div class="overlay-shield" aria-hidden="true"></div>
  
  {# Kind selector tabs #}
  <div class="kind-selector" style="margin-bottom: 1rem;">
    <div style="display: flex; gap: 1rem; justify-content: center;">
      <a href="{{ prefix }}/cash_doc?kind=receive" 
         class="kind-tab {% if cash_kind == 'receive' %}active{% endif %}"
         style="padding: 0.75rem 2rem; border-radius: 8px; text-decoration: none; font-weight: bold; transition: all 0.2s; {% if cash_kind == 'receive' %}background: #28a745; color: white;{% else %}background: #f8f9fa; color: #333; border: 2px solid #ddd;{% endif %}">
        โ ุฏุฑุงูุช
      </a>
      <a href="{{ prefix }}/cash_doc?kind=payment" 
         class="kind-tab {% if cash_kind == 'payment' %}active{% endif %}"
         style="padding: 0.75rem 2rem; border-radius: 8px; text-decoration: none; font-weight: bold; transition: all 0.2s; {% if cash_kind == 'payment' %}background: #dc3545; color: white;{% else %}background: #f8f9fa; color: #333; border: 2px solid #ddd;{% endif %}">
        โ ูพุฑุฏุงุฎุช
      </a>
    </div>
  </div>

  <h2>{% if cash_kind == 'receive' %}โ ุฏุฑุงูุช ูุฌู{% else %}โ ูพุฑุฏุงุฎุช ูุฌู{% endif %}</h2>

  <form method="post" action="{{ prefix }}/cash_doc?kind={{ cash_kind }}" id="cash-form" novalidate data-persist="true" data-persist-key="cash_{{ cash_kind }}">
    <input type="hidden" name="cash_kind" value="{{ cash_kind }}">
    <input type="hidden" name="person_token" id="person_token">

    <div class="card" style="padding: 1.5rem;">
      <div style="display: flex; gap: 1rem; flex-wrap: wrap; align-items: flex-end;">
        <div style="flex: 1; min-width: 160px;">
          <label class="lbl" for="doc_number">ุดูุงุฑู ุณูุฏ</label>
          <input class="inp" name="doc_number" id="doc_number" value="{{ doc_number }}" readonly>
        </div>
        <div style="flex: 1; min-width: 160px;">
          <label class="lbl" for="doc_date_fa">ุชุงุฑุฎ (ุดูุณ)</label>
          <input class="inp" id="doc_date_fa" readonly value="{{ current_jdate }}" data-greg="{{ current_gdate }}">
          <input type="hidden" name="doc_date_greg" id="doc_date_greg" value="{{ current_gdate }}">
        </div>
        <div style="flex: 2; min-width: 250px;">
          <label class="lbl" for="person_search">ุทุฑู ุญุณุงุจ</label>
          <div class="customer-lock">
            <div class="search-wrapper">
              <input class="inp" id="person_search" placeholder="ุฌุณุชุฌู ู ุงูุชุฎุงุจ ุทุฑู ุญุณุงุจ..." autocomplete="off"
                     {% if prefill_person %}value="{{ prefill_person.name }}"{% endif %}>
              <div id="person_results" class="search-results" hidden></div>
            </div>
            <button type="button" id="person_unlock" {% if prefill_person %}{% else %}hidden{% endif %}>ุชุบุฑ ุทุฑู ุญุณุงุจ</button>
            <span class="lock-indicator"></span>
          </div>
          <div id="person_hint" class="hint">{% if prefill_person %}{{ prefill_person.code }} - {{ prefill_person.name }}{% else %}ุทุฑู ุญุณุงุจ ุงูุชุฎุงุจ ูุดุฏู ุงุณุช{% endif %}</div>
        </div>
        <div style="flex: 1; min-width: 200px;">
          <label class="lbl" for="amount">ูุจูุบ (ุชููุงู)</label>
          <input class="inp ta-num" name="amount" id="amount" inputmode="decimal" required
                 value="{% if prefill_amount %}{{ prefill_amount }}{% endif %}">
        </div>
      </div>

      <div style="margin-top: 1.5rem; display: flex; gap: 1rem; flex-wrap: wrap;">
        <div style="flex: 1; min-width: 200px;">
          <label class="lbl" for="method">ุฑูุด ูพุฑุฏุงุฎุช</label>
          <select class="inp" name="method" id="method">
            <option value="cash">ููุฏ</option>
            <option value="pos">ฺฉุงุฑุชุฎูุงู (POS)</option>
            <option value="bank">ุจุงูฺฉ (ุญูุงูู)</option>
            <option value="cheque">ฺฺฉ</option>
          </select>
        </div>
        
        {# ููุท ุตูุฏููโูุง ฺฉู ุซุจุช ุดุฏูโุงูุฏ ููุงุด ุฏุงุฏู ุดููุฏ - ุจู ุฌุฒ ฺฺฉ ฺฉู ููุดู ููุงุด ุฏุงุฏู ูโุดูุฏ #}
        <div id="cashbox_container" style="flex: 2; min-width: 300px; display: none;">
          <label class="lbl" for="cashbox_id">ุตูุฏูู/ุญุณุงุจ (ุงุฎุชุงุฑ)</label>
          <select class="inp" name="cashbox_id" id="cashbox_id">
            <option value="">ุจุฏูู ุงูุชุฎุงุจ ุตูุฏูู</option>
            {% if cashboxes %}
              {% for cb in cashboxes %}
                <option value="{{ cb.id }}" data-kind="{{ cb.kind }}">{{ cb.name }} ({{ cb.kind }})</option>
              {% endfor %}
            {% endif %}
          </select>
          <div class="hint">{% if not cashboxes %}ูููุฒ ุตูุฏูู ุซุจุช ูุดุฏู ุงุณุช.{% else %}ุงูุชุฎุงุจ ุตูุฏูู ุจุฑุง ุฑูุดโูุง ููุฏ ู ุจุงูฺฉ ุงุฎุชุงุฑ ุงุณุช.{% endif %}</div>
        </div>

        <div style="flex: 3; min-width: 300px;">
          <label class="lbl" for="note">ุชูุถุญุงุช</label>
          <input class="inp" name="note" id="note" value="{% if prefill_note %}{{ prefill_note }}{% endif %}">
        </div>
      </div>

      {# ููุฏูุง ฺฺฉ - ููุท ููุช ุฑูุด ฺฺฉ ุงุณุช #}
      <div id="cheque_fields" style="display: none; margin-top: 1.5rem; padding: 1rem; background: #f8f9fa; border-radius: 8px;">
        <h4 style="margin: 0 0 1rem 0;">๐ ูุดุฎุตุงุช ฺฺฉ</h4>
        <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
          <div style="flex: 1; min-width: 200px;">
            <label class="lbl" for="cheque_number">ุดูุงุฑู ุตุงุฏ ฺฺฉ (ฑถ ุฑูู)</label>
            <input class="inp" name="cheque_number" id="cheque_number" maxlength="16" pattern="\d{16}">
          </div>
          <div style="flex: 1; min-width: 180px;">
            <label class="lbl" for="cheque_due_date_fa">ุชุงุฑุฎ ุณุฑุฑุณุฏ</label>
            <input class="inp" name="cheque_due_date_fa" id="cheque_due_date_fa" data-jalali-input placeholder="ฑดฐณ/ฑฒ/ฑต">
          </div>
          <div style="flex: 1; min-width: 180px;">
            <label class="lbl" for="cheque_bank">ุจุงูฺฉ</label>
            <input class="inp" name="cheque_bank" id="cheque_bank" placeholder="ููุ ููุชุ ...">
          </div>
        </div>
        <div style="display: flex; gap: 1rem; flex-wrap: wrap; margin-top: 1rem;">
          <div style="flex: 1; min-width: 180px;">
            <label class="lbl" for="cheque_owner">ุตุงุญุจ ฺฺฉ</label>
            <input class="inp" name="cheque_owner" id="cheque_owner">
          </div>
          <div style="flex: 1; min-width: 180px;">
            <label class="lbl" for="cheque_branch">ุดุนุจู</label>
            <input class="inp" name="cheque_branch" id="cheque_branch">
          </div>
          <div style="flex: 1; min-width: 180px;">
            <label class="lbl" for="cheque_account">ุดูุงุฑู ุญุณุงุจ</label>
            <input class="inp" name="cheque_account" id="cheque_account">
          </div>
        </div>
      </div>
    </div>

    <div class="actions-row" style="margin-top: 1.5rem; display: flex; gap: 1rem; justify-content: flex-end;">
      <button class="btn-primary" type="submit">
        ๐พ ุซุจุช {{ 'ุฏุฑุงูุช' if cash_kind == 'receive' else 'ูพุฑุฏุงุฎุช' }}
      </button>
    </div>
  </form>
</div>

<script>
(function() {
  const methodSelect = document.getElementById('method');
  const cashboxContainer = document.getElementById('cashbox_container');
  const cashboxSelect = document.getElementById('cashbox_id');
  const chequeFields = document.getElementById('cheque_fields');
  const hasCashboxes = {{ 'true' if cashboxes else 'false' }};

  function updateFields() {
    const method = methodSelect.value;
    
    // ููุท ุจุฑุง ฺฺฉ ุตูุฏูู ุงุฌุจุงุฑ ุงุณุช ู ุจุงุฏ ููุงุด ุฏุงุฏู ุดูุฏ
    if (method === 'cheque') {
      cashboxContainer.style.display = 'block';
      chequeFields.style.display = 'block';
      // ููุท ุญุณุงุจโูุง ุจุงูฺฉ ุฑุง ููุงุด ุจุฏู
      Array.from(cashboxSelect.options).forEach(opt => {
        if (opt.value && opt.dataset.kind !== 'bank') {
          opt.style.display = 'none';
        } else {
          opt.style.display = 'block';
        }
      });
    } else {
      chequeFields.style.display = 'none';
      // ุจุฑุง ุณุงุฑ ุฑูุดโูุงุ ููุท ุงฺฏุฑ ุตูุฏูู ุซุจุช ุดุฏู ุจุงุดุฏ ููุงุด ุจุฏู
      if (hasCashboxes) {
        cashboxContainer.style.display = 'block';
        // ููุงุด ููู ุตูุฏููโูุง
        Array.from(cashboxSelect.options).forEach(opt => {
          opt.style.display = 'block';
        });
      } else {
        cashboxContainer.style.display = 'none';
      }
    }
  }

  methodSelect.addEventListener('change', updateFields);
  updateFields();

  // ูพุดโููุฏุงุฑุฏู person_token ุงฺฏุฑ ุงุฒ ูุงฺฉุชูุฑ ุขูุฏู
  {% if prefill_person %}
  document.getElementById('person_token').value = '{{ prefill_person.id }}';
  {% endif %}
})();
</script>
{% endblock %}
