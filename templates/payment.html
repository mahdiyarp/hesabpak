{% extends "base.html" %}
{% block content %}
<div class="module-wrap">
  <h2>ğŸ’³ Ù¾Ø±Ø¯Ø§Ø®Øª ÙˆØ¬Ù‡</h2>

  <form method="post" action="{{ prefix }}/payment" id="payment-form" novalidate data-persist="true" data-persist-key="payment">
    <!-- Ø³Ø±Ø¨Ø±Ú¯ -->
    <div class="card header-box">
      <div class="header-grid">
        <div>
          <label class="lbl">Ø´Ù…Ø§Ø±Ù‡ Ø³Ù†Ø¯</label>
          <input class="inp" name="pay_number" id="pay_number" value="{{ pay_number|fa_digits }}" readonly>
        </div>

        <div>
          <label class="lbl">ØªØ§Ø±ÛŒØ® (Ø´Ù…Ø³ÛŒ)</label>
          <input class="inp" id="pay_date_fa" readonly value="{{ current_jdate|fa_digits }}" data-greg="{{ current_gdate }}">
          <input type="hidden" name="pay_date_greg" id="pay_date_greg" value="{{ current_gdate }}">
        </div>

        <div>
          <label class="lbl">Ø·Ø±Ù Ø­Ø³Ø§Ø¨ (Ø´Ø®Øµ)</label>
          <input type="hidden" name="person_token" id="person_token" value="{{ prefill_person.id if prefill_person else '' }}">
          <div class="search-wrapper">
            <input class="inp" id="person_search" placeholder="Ø¬Ø³ØªØ¬Ùˆ Ùˆ Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø®Øµ..." value="{% if prefill_person %}{{ prefill_person.code|fa_digits }} â€” {{ prefill_person.name }}{% endif %}">
            <div id="person_results" class="search-results"></div>
          </div>
          <div id="person_hint" class="hint">{% if prefill_person %}{{ prefill_person.name }} Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø¯Ù‡ Ø§Ø³Øª{% else %}Ù†Ø§Ù… ÛŒØ§ Ú©Ø¯ Ø´Ø®Øµ Ø±Ø§ Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯ Ùˆ Ø§Ø² Ù„ÛŒØ³Øª Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯.{% endif %}</div>
        </div>

        <div>
          <label class="lbl">Ù…Ø¨Ù„Øº (ØªÙˆÙ…Ø§Ù†)</label>
          <input class="inp" name="amount" id="amount" placeholder="Ù…Ø«Ù„Ø§Ù‹ 2,500,000" value="{% if prefill_amount is not none %}{{ prefill_amount|sep }}{% endif %}">
          <div class="amt-meta">
            <div id="amount_words" class="sum-words">â€”</div>
            <div id="pos_status" class="pos-status" data-device="{{ pos_device_key }}" data-label="{{ pos_device_label }}"></div>
          </div>
        </div>

        <div>
          <label class="lbl">Ø±ÙˆØ´ Ù¾Ø±Ø¯Ø§Ø®Øª</label>
          <select class="inp" name="method" id="method">
            <option value="cash">Ù†Ù‚Ø¯ÛŒ</option>
            <option value="pos">Ø¯Ø³ØªÚ¯Ø§Ù‡ Ù¾ÙˆØ²</option>
            <option value="bank">Ø¨Ø§Ù†Ú©ÛŒ (Ú©Ø§Ø±Øª Ø¨Ù‡ Ú©Ø§Ø±Øª/ÙˆØ§Ø±ÛŒØ²)</option>
            <option value="cheque">Ú†Ú©</option>
          </select>
        </div>
        <div>
          <label class="lbl">ØµÙ†Ø¯ÙˆÙ‚/Ø­Ø³Ø§Ø¨ Ù…Ø¨Ø¯Ø£</label>
          <select class="inp" name="cashbox_id" id="cashbox_id" {% if not cashboxes %}disabled{% endif %}>
            <option value="">{% if cashboxes %}Ø§Ù†ØªØ®Ø§Ø¨ Ø­Ø³Ø§Ø¨ Ù¾Ø±Ø¯Ø§Ø®Øªâ€ŒÚ©Ù†Ù†Ø¯Ù‡...{% else %}Ù‡ÛŒÚ† ØµÙ†Ø¯ÙˆÙ‚ ÙØ¹Ø§Ù„ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª{% endif %}</option>
            {% for box in cashboxes %}
              <option value="{{ box.id }}" data-kind="{{ box.kind }}" data-bank="{{ box.bank_name or '' }}" data-account="{{ box.account_no or '' }}">
                {{ box.name }}{% if box.kind == 'bank' and box.bank_name %} â€” {{ box.bank_name }}{% endif %}{% if box.account_no %} ({{ box.account_no|fa_digits }}){% endif %}
              </option>
            {% endfor %}
          </select>
          <div class="hint">Ø§Ù†ØªØ®Ø§Ø¨ ØµÙ†Ø¯ÙˆÙ‚ ÛŒØ§ Ø­Ø³Ø§Ø¨ Ø³Ø§Ø²Ú¯Ø§Ø± Ø¨Ø§ Ø±ÙˆØ´ Ù¾Ø±Ø¯Ø§Ø®Øª Ø§Ù„Ø²Ø§Ù…ÛŒ Ø§Ø³Øª.</div>
        </div>
      </div>
    </div>

    <!-- ØªÙˆØ¶ÛŒØ­ -->
    <div class="card">
      <label class="lbl">ØªÙˆØ¶ÛŒØ­</label>
      <input class="inp" name="note" id="note" placeholder="Ø§Ø®ØªÛŒØ§Ø±ÛŒ" value="{{ prefill_note if prefill_note else '' }}">
    </div>

    <div class="card cheque-wrapper" id="cheque_fields" hidden>
      <h4 class="cheque-title">ØµØ¯ÙˆØ± Ú†Ú© Ù¾Ø±Ø¯Ø§Ø®ØªÛŒ</h4>
      <div class="cheque-card">
        <div class="cheque-row">
          <label for="cheque_number">Ø´Ù…Ø§Ø±Ù‡ ØµÛŒØ§Ø¯ÛŒ</label>
          <input class="cheque-input" id="cheque_number" name="cheque_number" maxlength="23" placeholder="Û±Û¶ Ø±Ù‚Ù…" autocomplete="off">
        </div>
        <div class="cheque-row">
          <label for="cheque_bank">Ø¨Ø§Ù†Ú©</label>
          <input class="cheque-input" id="cheque_bank" name="cheque_bank" placeholder="Ø¨Ø§Ù†Ú© ØµØ§Ø¯Ø±Ú©Ù†Ù†Ø¯Ù‡">
          <label for="cheque_branch">Ø´Ø¹Ø¨Ù‡</label>
          <input class="cheque-input" id="cheque_branch" name="cheque_branch" placeholder="Ù…Ø«Ù„Ø§Ù‹ Ù…Ø±Ú©Ø²ÛŒ">
        </div>
        <div class="cheque-row">
          <label for="cheque_account">Ø´Ù…Ø§Ø±Ù‡ Ø­Ø³Ø§Ø¨</label>
          <input class="cheque-input" id="cheque_account" name="cheque_account" placeholder="Ø´Ù…Ø§Ø±Ù‡ Ø­Ø³Ø§Ø¨">
          <label for="cheque_owner">ØµØ§Ø­Ø¨ Ø­Ø³Ø§Ø¨</label>
          <input class="cheque-input" id="cheque_owner" name="cheque_owner" placeholder="Ù†Ø§Ù… ØµØ§Ø­Ø¨ Ø­Ø³Ø§Ø¨">
        </div>
        <div class="cheque-row">
          <label for="cheque_due_date_fa">ØªØ§Ø±ÛŒØ® Ø³Ø±Ø±Ø³ÛŒØ¯ (Ø´Ù…Ø³ÛŒ)</label>
          <input class="cheque-input" type="text" id="cheque_due_date_fa" name="cheque_due_date_fa" data-jalali-input data-jalali-target="cheque_due_date" placeholder="Û±Û´Û°Û³-Û°Û±-Û±Ûµ" autocomplete="off">
          <input type="hidden" id="cheque_due_date" name="cheque_due_date">
          <div class="cheque-hint">Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú†Ú© Ø¯Ø± Ú¯Ø²Ø§Ø±Ø´Ø§Øª Ùˆ Ø¬Ø³ØªØ¬Ùˆ Ù‚Ø§Ø¨Ù„ Ù¾ÛŒÚ¯ÛŒØ±ÛŒ Ø®ÙˆØ§Ù‡Ø¯ Ø¨ÙˆØ¯.</div>
        </div>
      </div>
    </div>

    <!-- Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ -->
    <div class="actions">
      <button class="btn btn-primary" type="submit">Ø«Ø¨Øª Ù¾Ø±Ø¯Ø§Ø®Øª</button>
      <a class="btn" href="{{ prefix }}/">Ø¨Ø§Ø²Ú¯Ø´Øª</a>
    </div>
  </form>
</div>

<style>
  .amt-meta{ margin-top:6px; display:flex; flex-direction:column; gap:4px; }
  .sum-words{ font-size:12px; background:var(--c-accent-soft); color:var(--c-mid); padding:6px 10px; border-radius:8px; }
  .pos-status{ font-size:12px; color:var(--c-accent); }
  .hint.selected{ color:var(--c-accent); font-weight:600; }
</style>
<script>
(function(){
  const fa = document.getElementById('pay_date_fa');
  const ge = document.getElementById('pay_date_greg');
  if(fa && ge && fa.dataset.greg){
    ge.value = fa.dataset.greg;
  }

  const personToken = document.getElementById('person_token');
  const personSearch= document.getElementById('person_search');
  const personBox   = document.getElementById('person_results');
  const personHint  = document.getElementById('person_hint');
  const methodSel   = document.getElementById('method');
  const cashboxSel  = document.getElementById('cashbox_id');
  const chequeFields= document.getElementById('cheque_fields');
  const chequeNumber= document.getElementById('cheque_number');
  const chequeBank  = document.getElementById('cheque_bank');

  function show(el){ if(!el) return; el.hidden=false; el.style.display='block'; }
  function hide(el){ if(!el) return; el.hidden=true; el.style.display='none'; }

  let tmr=null;
  function searchPerson(q){
    fetch(window.prefix+'/api/search?q='+encodeURIComponent(q)+'&kind=person&limit=10',{credentials:'same-origin'})
      .then(r=>r.ok?r.json():[])
      .then(list=>{
        if(!Array.isArray(list) || list.length===0){ personBox.innerHTML='<div class="empty">ÛŒØ§ÙØª Ù†Ø´Ø¯</div>'; show(personBox); return; }
        personBox.innerHTML=list.map(m=>`<a href="#" data-id="${m.id}" data-code="${m.code}">${m.name} â€” <code>${m.code}</code></a>`).join('');
        show(personBox);
      })
      .catch(()=>{ personBox.innerHTML='<div class="empty">Ø®Ø·Ø§ Ø¯Ø± Ø¬Ø³ØªØ¬Ùˆ</div>'; show(personBox); });
  }

  personSearch.addEventListener('input', function(){
    const q=(this.value||'').trim();
    clearTimeout(tmr);
    if(!q){ hide(personBox); return; }
    tmr=setTimeout(()=>searchPerson(q), 250);
  });

  personBox.addEventListener('click', function(ev){
    const a=ev.target.closest('a'); if(!a) return;
    ev.preventDefault();
    personToken.value=a.dataset.id;
    personSearch.value=a.textContent.trim();
    personHint.textContent=a.textContent.trim();
    personHint.classList.add('selected');
    hide(personBox);
  });

  document.addEventListener('click', function(ev){
    if(ev.target.closest('.search-wrapper')) return;
    hide(personBox);
  });

  if(personToken && personToken.value){
    personHint.classList.add('selected');
  }

  function syncChequeUI(){
    const method = methodSel ? methodSel.value : '';
    const isCheque = method === 'cheque';
    if(chequeFields){
      if(isCheque){ show(chequeFields); } else { hide(chequeFields); }
    }
    if(!cashboxSel) return;
    Array.from(cashboxSel.options).forEach(opt=>{
      if(!opt.value){ opt.hidden = false; return; }
      const kind = opt.dataset.kind || 'cash';
      if(method === 'cash'){ opt.hidden = kind !== 'cash'; }
      else if(method === 'bank' || method === 'cheque'){ opt.hidden = kind !== 'bank'; }
      else { opt.hidden = false; }
    });
    if(cashboxSel.value){
      const sel = cashboxSel.options[cashboxSel.selectedIndex];
      if(sel && sel.hidden){ cashboxSel.value=''; }
    }
  }

  methodSel && methodSel.addEventListener('change', syncChequeUI);

  if(cashboxSel){
    cashboxSel.addEventListener('change', function(){
      const opt = this.options[this.selectedIndex];
      if(opt && chequeBank && !chequeBank.value){
        const bankLabel = opt.dataset.bank || '';
        if(bankLabel){ chequeBank.value = bankLabel; }
      }
    });
  }

  if(chequeNumber){
    chequeNumber.addEventListener('input', function(){
      const digits = this.value.replace(/\D/g,'').slice(0,16);
      const grouped = digits.replace(/(.{4})/g,'$1 ').trim();
      this.value = grouped;
    });
  }

  syncChequeUI();

  const amountInp=document.getElementById('amount');
  const amountWords=document.getElementById('amount_words');
  const posStatus=document.getElementById('pos_status');
  const posDevice=posStatus ? (posStatus.dataset.device||'none') : 'none';
  const posLabel=posStatus ? (posStatus.dataset.label||'') : '';

  function fmtAmount(val){
    if(val==null) return '';
    const s=String(val).replace(/[^0-9]/g,'');
    if(!s) return '';
    return s.replace(/\B(?=(\d{3})+(?!\d))/g,',');
  }

  let amtTimer=null;
  function updateAmountMeta(){
    if(!amountInp) return;
    const raw=amountInp.value.replace(/,/g,'');
    const num=parseFloat(raw||'0');
    amountWords.textContent='â€”';
    if(posStatus){ posStatus.textContent=''; }
    if(!raw){ return; }
    if(amtTimer) clearTimeout(amtTimer);
    amtTimer=setTimeout(()=>{
      fetch(window.prefix+'/api/num2words?amount='+encodeURIComponent(raw),{credentials:'same-origin'})
        .then(r=>r.ok?r.json():{})
        .then(j=>{ if(j && j.ok){ amountWords.textContent=j.text; } })
        .catch(()=>{ amountWords.textContent='â€”'; });
      if(posStatus && posDevice && posDevice!=='none' && num>0){
        posStatus.textContent=`Ø§Ø±Ø³Ø§Ù„ Ø®ÙˆØ¯Ú©Ø§Ø± Ù…Ø¨Ù„Øº ${fmtAmount(raw)} ØªÙˆÙ…Ø§Ù† Ø¨Ù‡ ${posLabel}`;
        if(methodSel && methodSel.value==='cash'){ methodSel.value='pos'; syncChequeUI(); }
      }
    }, 220);
  }

  amountInp && amountInp.addEventListener('input', function(){
    const raw=this.value;
    const formatted=fmtAmount(raw);
    this.value=formatted;
    updateAmountMeta();
    this.setSelectionRange(formatted.length, formatted.length);
  });

  if(amountInp && amountInp.value){
    updateAmountMeta();
  }
})();
</script>
{% endblock %}
